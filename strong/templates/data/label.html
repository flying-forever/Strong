{% extends 'data/_data.html' %}
{% block top_bar %}
<a id="tag_create" class="btn btn-success" href="#">+新标签</a>
{% endblock %}


{% block show %}
{{ super() }}

<!-- 标签修改，模态框 -->
<div class="modal fade" id="tagModal" tabindex="-1" role="dialog" aria-labelledby="tagModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
            <!-- 顶栏 -->
            <div class="modal-header">
                <h5 class="modal-title" id="tagModalLabel">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <!-- 模态框正文 -->
            <form id="tagForm" action="">
                <div class="alert alert-success" role="alert" id="message" style="display: none;">用于发送提示消息</div>
                <div class="modal-body" id="modalBody">
                    <!-- 输入列表 -->
                    <div class="form-group">
                        <label>名称:</label>
                        <input type="text" id="tagname" class="form-control" name="tagname">
                    </div>

                    <div class="form-group">
                        <label>父节点:</label>
                        <input type="text" id="pname" class="form-control" name="pname">
                    </div>
                    <div class="form-group">
                        <label>子节点:</label>
                        <div class="btn-toolbar" id="childs" role="toolbar" aria-label="Toolbar with button groups">
                        </div>
                    </div>
                    <!-- 被点击的星球的id -->
                    <input id="tagid" type="hidden" value="" name="tagid">
                </div>
                <!-- 底栏 -->
                <div class="modal-footer">
                    <button id="tag_delete" type="button" class="btn btn-danger">删除标签</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button id="submit" type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 星图，echarts -->
<script type="text/javascript">
    var myChart = echarts.init(document.getElementById('main'), 'wonderland');
    var datas = {{ datas | tojson | safe }};  // tojson过滤，将True变成true

    // 1 图表配置
    var option = {
        tooltip: {
            trigger: 'item',
            triggerOn: 'mousemove'
        },
        series: [{
            type: 'tree',
            data: [datas, {name:'tag'}],
            top: '10%',
            bottom: '10%',
            layout: 'radial',
            symbol: 'emptyCircle',
            symbolSize: 7,
            initialTreeDepth: 2,
            animationDurationUpdate: 750,
            emphasis: {
                focus: 'descendant'
            },
            roam: true, //鼠标缩放
            draggable: true, //可拖拽
            // label: { show: true, fontSize: 12},  // 注释时对series的整体label操作就失效
        }]
    }
    myChart.setOption(option);

    // 1.1 监听 zoom 事件，当缩放发生时执行对应的处理程序
    myChart.on('treeroam', function (params) {
        // 备注：连续缩放时，会导致明显的卡顿。
        // 备注：每个node的size单独操作呢？
        var scale = params.zoom;  // 拖拽事件会得到undefine，可查看echarts的event相关文档

        var label = option.series[0].label;
        if (scale) {
            scale = scale > 1 ? 1.1 : 0.9090909090909090909  // 比图像比例迟缓，且缩和放是可逆的
            var oriSize = label.fontSize;
            var labelFontSize = oriSize * scale; // 例如，按比例缩放字体大小
            console.log('graphroam', scale, labelFontSize);

            label.fontSize = labelFontSize;
            myChart.setOption(option);
        }
    });

    // 2 双击星球 —> 唤出模态框
    myChart.on('dblclick',
        function (params) {
            console.log(params.name, params.value, params.data);

            var modal = $('#tagModal');
            modal.modal('show');
            modal.find('.modal-title').text(params.name);
            modal.find('input#tagname').val(params.name);
            modal.find('input#tagid').val(params.data.id);  // 

            // 找父节点
            find_parent = function (node) {
                var childs = node.children;
                for (var i = 0; i < childs.length; i++) {
                    if (childs[i].name == params.data.name) {
                        modal.find('input#pname').val(node.name);
                        return true
                    } else {
                        if(find_parent(childs[i])){ return true; }
                    }
                }
            }
            var root = option.series[0].data[0];
            find_parent(root)
        }
    )

    // 3 模态框隐藏 -> 清空内容
    $('#tagModal').on('hidden.bs.modal', function (e) {
        // 备注：怎么能直接刷新为初始状态，不用一个个操作？
        // 刷新表单值
        $('form input').val('');
        // 刷新填入的标签元素 (现在多余了)
        var clearIds = ['childs'];
        for (var i = 0; i < clearIds.length; i++) {
            var container = document.getElementById(clearIds[i]);
            container.innerHTML = '';
        }
    });

    // 4 新建标签 - 唤出模态框
    $('#tag_create').on('click', function (e) {
        var modal = $('#tagModal');
        modal.modal('show');
        modal.find('.modal-title').text('新的标签');
    });

    // 5 新建标签 - 异步发送表单请求，动态更新
    $('#submit').on('click', function (e) {
        e.preventDefault();
        var formData = $('#tagForm').serialize(); // 序列化表单数据
        // console.log(formData);
        $.ajax({
            url: "{{ url_for('task.tag_node') }}",
            type: 'POST',
            data: formData,
            success: function (response) {
                console.log('res', response);
                // response已经是js原生类型，再用JSON.parse解析会报错
                var res = response;
                console.log(res);
                if (res.success) {
                    $('#message').text('操作成功').show();
                    $.ajax({    
                        // 备注：这个ajax请求写得简洁，其它都有大段的非核心代码。
                        url: "{{ url_for('data.get_tree_data', time_id=time_id) }}",
                        type: 'GET', 
                        success: function (response) {
                            var data = response;
                            option.series[0].data[0] = data;
                            myChart.setOption(option);
                        }
                    })

                    setTimeout(function () {
                        $('#message').hide();
                        $('#tagModal').modal('hide');
                    }, 500);
                } else {
                    $('#message').text(res.message).show();
                    setTimeout(function () {
                        $('#message').hide();
                    }, 1500);
                }
            },
            error: function (xhr, status, error) {
                console.error('Error', error);
            },
        });
    });

    // 6 删除标签 - 异步请求
    $('#tag_delete').on('click', function (e) {
        // 备注：好多样板代码
        var formData = $('#tagForm').serialize(); // 序列化表单数据
        $.ajax({
            url: "{{ url_for('task.tag_delete') }}",
            type: 'POST',
            data: formData,
            success: function (res) {
                if (res.success) {
                    // 动态更新，删除对应node
                    var id = $('#tagid').val();
                    console.log(id);

                    // 找到id对应的标签，在tree中删除
                    var root = option.series[0].data[0];
                    del_node = function (childs, id) {
                        for (var i = 0; i < childs.length; i++) {
                            if (childs[i].id == id) {
                                console.log('del_node', childs[i]);
                                childs.splice(i, 1);
                                return true;
                            } else {
                                if (del_node(childs[i].children, id)) {return true;}
                            }
                        }
                    }
                    del_node(root.children, id);
                    myChart.setOption(option);

                    $('#message').text('操作成功').show();
                    setTimeout(function () {
                        $('#message').hide();
                        $('#tagModal').modal('hide');
                    }, 500);
                } else {
                    $('#message').text('操作失败').show();
                    setTimeout(function () {
                        $('#message').hide();
                    }, 1500);
                }
            },
            error: function (xhr, status, error) { console.error('Error', error); },
        });
    });

</script>
{% endblock show %}